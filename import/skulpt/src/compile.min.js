function Compiler(a,b,c,d){this.filename=a,this.st=b,this.flags=c,this.interactive=!1,this.nestlevel=0,this.u=null,this.stack=[],this.result=[],this.gensymcount=0,this.allUnits=[],this.source=d?d.split("\n"):!1}function CompilerUnit(){this.ste=null,this.name=null,this.private_=null,this.firstlineno=0,this.lineno=0,this.linenoSet=!1,this.localnames=[],this.blocknum=0,this.blocks=[],this.curblock=0,this.scopename=null,this.prefixCode="",this.varDeclsCode="",this.switchCode="",this.suffixCode="",this.breakBlocks=[],this.continueBlocks=[],this.exceptBlocks=[],this.finallyBlocks=[]}function fixReservedWords(a){return reservedWords_[a]!==!0?a:a+"_$rw$"}function mangleName(a,b){var c=b.v;return null===a||null===c||"_"!==c.charAt(0)||"_"!==c.charAt(1)?b:"_"===c.charAt(c.length-1)&&"_"===c.charAt(c.length-2)?b:""===a.v.replace(/_/g,"")?b:(a=a.v.replace(/^_*/,""),"_"+a+c)}var out;Compiler.prototype.getCurrentLevel=function(scope){var scopename=void 0!=scope?scope:this.u.scopename,lastIndex=eval()-1;return"$loc["+Sk.problem+"]."+scopename+".stack[$loc["+Sk.problem+"]."+scopename+".stack.length - 1]"},Compiler.prototype.getStack=function(a){return"$loc["+Sk.problem+"]."+(void 0!=a?a:this.u.scopename)+".stack"},CompilerUnit.prototype.activateScope=function(){var a=this;out=function(){for(var b=a.blocks[a.curblock],c=0;arguments.length>c;++c)b.push(arguments[c])}},Compiler.prototype.getSourceLine=function(a){return goog.asserts.assert(this.source),this.source[a-1]},Compiler.prototype.annotateSource=function(a){if(this.source){var b=a.lineno,c=a.col_offset;out("\n//\n// line ",b,":\n// ",this.getSourceLine(b),"\n// ");for(var d=0;c>d;++d)out(" ");out("^\n//\n"),this.u.blocks[this.u.curblock].lineno=b-1}},Compiler.prototype.gensym=function(a){return a=a||"",a=this.getCurrentLevel()+".loc."+a,a+=this.gensymcount++},Compiler.prototype.niceName=function(a){return this.gensym(a.replace("<","").replace(">","").replace(" ","_"))};var reservedWords_={"abstract":!0,as:!0,"boolean":!0,"break":!0,"byte":!0,"case":!0,"catch":!0,"char":!0,"class":!0,"continue":!0,"const":!0,"debugger":!0,"default":!0,"delete":!0,"do":!0,"double":!0,"else":!0,"enum":!0,"export":!0,"extends":!0,"false":!0,"final":!0,"finally":!0,"float":!0,"for":!0,"function":!0,"goto":!0,"if":!0,"implements":!0,"import":!0,"in":!0,"instanceof":!0,"int":!0,"interface":!0,is:!0,"long":!0,namespace:!0,"native":!0,"new":!0,"null":!0,"package":!0,"private":!0,"protected":!0,"public":!0,"return":!0,"short":!0,"static":!0,"super":!0,"switch":!0,"synchronized":!0,"this":!0,"throw":!0,"throws":!0,"transient":!0,"true":!0,"try":!0,"typeof":!0,use:!0,"var":!0,"void":!0,"volatile":!0,"while":!0,"with":!0};Compiler.prototype._gr=function(a){var c=this.gensym(a);out(c," = ");for(var d=1;arguments.length>d;++d)out(arguments[d]);return out(";"),c},Compiler.prototype._gr_=function(a,b){var d=this.gensym(b);out("if(eval("+a+") != undefined){"),out("$loc["+Sk.problem+"].parent = $scope["+Sk.problem+"];\n"),out("$loc["+Sk.problem+"].parentName = $scopename["+Sk.problem+"];\n"),out("$loc["+Sk.problem+"].parentStack = $scopestack["+Sk.problem+"];\n"),out("$loc["+Sk.problem+'].call = "',d,'";\n'),out("}\n"),out("else $expr["+Sk.problem+"] = 1;\n"),out(d," = ");for(var e=2;arguments.length-1>e;++e)out(arguments[e]);return out(");\n"),d},Compiler.prototype._jumpfalse=function(a,b,c){var d=this._gr("jfalse","(",a," === false || !Sk.misceval.isTrue(",a,"))");out("if(",d,"){/*test failed */"+this.getCurrentLevel()+".blk = ",b,";",void 0!=c?"$expr["+Sk.problem+"] = "+c+";":"","break;}")},Compiler.prototype._jumpundef=function(a,b,c){out("if(",a," === undefined){"+this.getCurrentLevel()+".blk = ",b,";",void 0!=c?"$expr["+Sk.problem+"] = "+c+";":"","break;}")},Compiler.prototype._jumptrue=function(a,b){var c=this._gr("jtrue","(",a," === true || Sk.misceval.isTrue(",a,"))");out("if(",c,"){/*test passed */"+this.getCurrentLevel()+".blk = ",b,";break;}")},Compiler.prototype._jump=function(a,b){out(this.getCurrentLevel()+".blk = ",a,";",void 0!=b?"$expr["+Sk.problem+"] = "+b+";":"","/* jump */break;")},Compiler.prototype.ctupleorlist=function(a,b,c){if(goog.asserts.assert("tuple"===c||"list"===c),a.ctx===Store)for(var d=0;a.elts.length>d;++d)this.vexpr(a.elts[d],"Sk.abstr.objectGetItem("+b+", "+d+")");else if(a.ctx===Load){for(var e=[],d=0;a.elts.length>d;++d)e.push(this._gr("elem",this.vexpr(a.elts[d])));return this._gr("load"+c,"new Sk.builtins['",c,"']([",e,"])")}},Compiler.prototype.cdict=function(a){goog.asserts.assert(a.values.length===a.keys.length);for(var b=[],c=0;a.values.length>c;++c){var d=this.vexpr(a.values[c]);b.push(this.vexpr(a.keys[c])),b.push(d)}return this._gr("loaddict","new Sk.builtins['dict']([",b,"])")},Compiler.prototype.clistcompgen=function(a,b,c,d){var e=this.newBlock("list gen start"),f=this.newBlock("list gen skip"),g=this.newBlock("list gen anchor"),h=b[c],i=this.vexpr(h.iter),j=this._gr("iter","Sk.abstr.iter(",i,")");this._jump(e),this.u.blocks[this.u.curblock].expr=1,this.setBlock(e),this.u.blocks[this.u.curblock].expr=1;var k=this._gr("next","Sk.abstr.iternext(",j,")");this._jumpundef(k,g),this.vexpr(h.target,k);for(var m=h.ifs.length,n=0;m>n;++n){var o=this.vexpr(h.ifs[n]);this._jumpfalse(o,e)}if(++c<b.length&&this.clistcompgen(a,b,c,d),c>=b.length){var p=this.vexpr(d);out(a,".v.push(",p,");"),this._jump(f),this.setBlock(f),this.u.blocks[this.u.curblock].expr=1}return this._jump(e),this.setBlock(g),this.u.blocks[this.u.curblock].expr=1,a},Compiler.prototype.clistcomp=function(a){goog.asserts.assert(a instanceof ListComp);var b=this._gr("_compr","new Sk.builtins['list']([])");return this.clistcompgen(b,a.generators,0,a.elt)},Compiler.prototype.cyield=function(a){if(this.u.ste.blockType!==FunctionBlock)throw new SyntaxError("'yield' outside function");var b="null";a.value&&(b=this.vexpr(a.value));var c=this.newBlock("after yield");return out("return [/*resume*/",c,",/*ret*/",b,"];"),this.setBlock(c),"$gen.gi$sentvalue"},Compiler.prototype.ccompare=function(a){goog.asserts.assert(a.ops.length===a.comparators.length);for(var b=this.vexpr(a.left),c=a.ops.length,d=this.newBlock("done"),e=this._gr("compareres","null"),f=0;c>f;++f){var g=this.vexpr(a.comparators[f]),h=this._gr("compare","Sk.misceval.richCompareBool(",b,",",g,",'",a.ops[f].prototype._astname,"')");out(e,"=",h,";"),this._jumpfalse(h,d),b=g,this.u.blocks[this.u.curblock].expr=1}return this._jump(d),this.setBlock(d),this.u.blocks[this.u.curblock].expr=1,e},Compiler.prototype.ccall=function(a){var b=this.vexpr(a.func,void 0,void 0,void 0,!0),d=this.vseqexpr(a.args);if(a.keywords.length>0||a.starargs||a.kwargs){for(var e=[],f=0;a.keywords.length>f;++f)e.push("'"+a.keywords[f].arg.v+"'"),e.push(this.vexpr(a.keywords[f].value));var g="["+e.join(",")+"]",h="undefined",i="undefined";return a.starargs&&(h=this.vexpr(a.starargs)),a.kwargs&&(i=this.vexpr(a.kwargs)),this._gr("call","Sk.misceval.call(",b,",",i,",",h,",",g,d.length>0?",":"",d,")")}block=this.newBlock(),out(this.getCurrentLevel()+".blk = ",block,";\n");var j;return"Attribute"==a.func._astname?(j=this._gr("call","Sk.misceval.callsim(",b,d.length>0?",":"",d,")"),out("$expr["+Sk.problem+"] = 1;\n")):(c="111",b.length&&(c=b[1],b=b[0]),j=this._gr_(c,"call","Sk.misceval.callsim(",b,d.length>0?",":"",d,")")),out("break;\n"),this.setBlock(block),this.u.blocks[this.u.curblock].lineno=a.lineno-1,j},Compiler.prototype.csimpleslice=function(a,b,c,d){goog.asserts.assert(null===a.step);var e="null",f="null";switch(a.lower&&(e=this.vexpr(a.lower)),a.upper&&(f=this.vexpr(a.upper)),b){case AugLoad:case Load:return this._gr("simpsliceload","Sk.misceval.applySlice(",c,",",e,",",f,")");case AugStore:case Store:out("Sk.misceval.assignSlice(",c,",",e,",",f,",",d,");");break;case Del:out("Sk.misceval.assignSlice(",c,",",e,",",f,",null);");break;case Param:default:goog.asserts.fail("invalid simple slice")}},Compiler.prototype.cslice=function(a){goog.asserts.assert(a instanceof Slice);var e=a.lower?this.vexpr(a.lower):"null",f=a.upper?this.vexpr(a.upper):"null",g=a.step?this.vexpr(a.step):"null";return this._gr("slice","new Sk.builtins['slice'](",e,",",f,",",g,")")},Compiler.prototype.vslice=function(a,b,c,d){var f,e=null;switch(a.constructor){case Index:e="index",f=this.vexpr(a.value);break;case Slice:if(!a.step)return this.csimpleslice(a,b,c,d);b!==AugStore&&(f=this.cslice(a,b,c,d));break;case Ellipsis:case ExtSlice:goog.asserts.fail("todo;");break;default:goog.asserts.fail("invalid subscript kind")}return this.chandlesubscr(e,b,c,f,d)},Compiler.prototype.chandlesubscr=function(a,b,c,d,e){return b===Load||b===AugLoad?this._gr("lsubscr","Sk.abstr.objectGetItem(",c,",",d,")"):(b===Store||b===AugStore?out("Sk.abstr.objectSetItem(",c,",",d,",",e,");"):b===Del?out("Sk.abstr.objectDelItem(",c,",",d,");"):goog.asserts.fail("handlesubscr fail"),void 0)},Compiler.prototype.cboolop=function(a){goog.asserts.assert(a instanceof BoolOp),this.u.blocks[this.u.curblock].expr=1;var b;b=a.op===And?this._jumpfalse:this._jumptrue;for(var g,d=this.newBlock("end of boolop"),e=a.values,f=e.length,h=0;f>h;++h){var i=this.vexpr(e[h]);0===h&&(g=this._gr("boolopsucc",i)),out(g,"=",i,";"),b.call(this,i,d)}return this._jump(d),this.setBlock(d),this.u.blocks[this.u.curblock].expr=1,g},Compiler.prototype.vexpr=function(a,b,c,d,e){switch(a.lineno>this.u.lineno&&(this.u.lineno=a.lineno,this.u.linenoSet=!1),a.constructor){case BoolOp:return this.cboolop(a);case BinOp:return this._gr("binop","Sk.abstr.numberBinOp(",this.vexpr(a.left),",",this.vexpr(a.right),",'",a.op.prototype._astname,"')");case UnaryOp:return this._gr("unaryop","Sk.abstr.numberUnaryOp(",this.vexpr(a.operand),",'",a.op.prototype._astname,"')");case Lambda:return this.clambda(a);case IfExp:return this.cifexp(a);case Dict:return this.cdict(a);case ListComp:return this.clistcomp(a);case GeneratorExp:return this.cgenexp(a);case Yield:return this.cyield(a);case Compare:return this.ccompare(a);case Call:return this.ccall(a);case Num:if("number"==typeof a.n)return a.n;if(a.n instanceof Sk.builtin.lng)return"Sk.longFromStr('"+a.n.tp$str().v+"')";goog.asserts.fail("unhandled Num type");case Str:return this._gr("str","new Sk.builtins['str'](",a.s.$r().v,")");case Attribute:var f;switch(a.ctx!==AugStore&&(f=this.vexpr(a.value)),a.ctx){case AugLoad:case Load:return this._gr("lattr","Sk.abstr.gattr(",f,",",a.attr.$r().v,")");case AugStore:out("if(",b,"!==undefined){"),f=this.vexpr(c||null),out("Sk.abstr.sattr(",f,",",a.attr.$r().v,",",b,");"),out("}");break;case Store:out("Sk.abstr.sattr(",f,",",a.attr.$r().v,",",b,");");break;case Del:goog.asserts.fail("todo;");break;case Param:default:goog.asserts.fail("invalid attribute expression")}break;case Subscript:var f;switch(a.ctx){case AugLoad:case Load:case Store:case Del:return this.vslice(a.slice,a.ctx,this.vexpr(a.value),b);case AugStore:out("if(",b,"!==undefined){"),f=this.vexpr(c||null),this.vslice(a.slice,a.ctx,f,b),out("}");break;case Param:default:goog.asserts.fail("invalid subscript expression")}break;case Name:return this.nameop(a.id,a.ctx,b,d,e);case List:return this.ctupleorlist(a,b,"list");case Tuple:return this.ctupleorlist(a,b,"tuple");default:goog.asserts.fail("unhandled case in vexpr")}},Compiler.prototype.vseqexpr=function(a,b){goog.asserts.assert(void 0===b||a.length===b.length);for(var c=[],d=0;a.length>d;++d)c.push(this.vexpr(a[d],void 0===b?void 0:b[d]));return c},Compiler.prototype.caugassign=function(a){goog.asserts.assert(a instanceof AugAssign);var b=a.target;switch(b.constructor){case Attribute:var c=new Attribute(b.value,b.attr,AugLoad,b.lineno,b.col_offset),d=this.vexpr(c),e=this.vexpr(a.value),f=this._gr("inplbinopattr","Sk.abstr.numberInplaceBinOp(",d,",",e,",'",a.op.prototype._astname,"')");return c.ctx=AugStore,this.vexpr(c,f,b.value);case Subscript:var c=new Subscript(b.value,b.slice,AugLoad,b.lineno,b.col_offset),d=this.vexpr(c),e=this.vexpr(a.value),f=this._gr("inplbinopsubscr","Sk.abstr.numberInplaceBinOp(",d,",",e,",'",a.op.prototype._astname,"')");return c.ctx=AugStore,this.vexpr(c,f,b.value);case Name:var g=this.nameop(b.id,Load),e=this.vexpr(a.value),f=this._gr("inplbinop","Sk.abstr.numberInplaceBinOp(",g,",",e,",'",a.op.prototype._astname,"')");return this.nameop(b.id,Store,f);default:goog.asserts.fail("unhandled case in augassign")}},Compiler.prototype.exprConstant=function(a){switch(a.constructor){case Num:return Sk.misceval.isTrue(a.n);case Str:return Sk.misceval.isTrue(a.s);case Name:default:return-1}},Compiler.prototype.newBlock=function(a){this.u.blocknum&&out("\n");var b=this.u.blocknum++;return this.u.blocks[b]=[],this.u.blocks[b]._name=a||"<unnamed>",b},Compiler.prototype.setBlock=function(a){goog.asserts.assert(a>=0&&this.u.blocknum>a),this.u.curblock=a},Compiler.prototype.pushBreakBlock=function(a){goog.asserts.assert(a>=0&&this.u.blocknum>a),this.u.breakBlocks.push(a)},Compiler.prototype.popBreakBlock=function(){this.u.breakBlocks.pop()},Compiler.prototype.pushContinueBlock=function(a){goog.asserts.assert(a>=0&&this.u.blocknum>a),this.u.continueBlocks.push(a)},Compiler.prototype.popContinueBlock=function(){this.u.continueBlocks.pop()},Compiler.prototype.pushExceptBlock=function(a){goog.asserts.assert(a>=0&&this.u.blocknum>a),this.u.exceptBlocks.push(a)},Compiler.prototype.popExceptBlock=function(){this.u.exceptBlocks.pop()},Compiler.prototype.pushFinallyBlock=function(a){goog.asserts.assert(a>=0&&this.u.blocknum>a),this.u.finallyBlocks.push(a)},Compiler.prototype.popFinallyBlock=function(){this.u.finallyBlocks.pop()},Compiler.prototype.setupExcept=function(a){out("$exc.push(",a,");try{")},Compiler.prototype.endExcept=function(){out("$exc.pop();}catch($err){"),out("$blk=$exc.pop();"),out("break;}")},Compiler.prototype.outputLocals=function(a){for(var b={},c=0;a.argnames&&a.argnames.length>c;++c)b[a.argnames[c]]=!0;a.localnames.sort();for(var d=[],c=0;a.localnames.length>c;++c){var e=a.localnames[c];void 0===b[e]&&(d.push(e),b[e]=!0)}return d.length>0?d.join(",")+"; /* locals */":""},Compiler.prototype.outputAllUnits=function(){for(var a="",b=this.allUnits.length-1;b>0;--b){var c=this.allUnits[b];a+=c.prefixCode,a+=c.varDeclsCode,a+="});"}a+="switch($scope["+Sk.problem+"]){\n";for(var b=0;this.allUnits.length>b;++b){var c=this.allUnits[b];a+="case "+b+":\n",a+=c.switchCode;for(var d=c.blocks,e=0;d.length>e;++e)a+="case "+e+": /* --- "+d[e]._name+" --- */",a+=d[e].join(""),a+="goog.asserts.fail('unterminated block');\n";a+=c.suffixCode,a+="break;\n"}return a+="}"},Compiler.prototype.cif=function(a){goog.asserts.assert(a instanceof If_);var b=this.exprConstant(a.test),c=this.newBlock("end of if");if(0===b)a.orelse&&this.vseqstmt(a.orelse);else if(1===b)this.vseqstmt(a.body);else{var d=this.vexpr(a.test,null,null,this);this.u.blocks[this.u.curblock].lineno=this.u.lineno-1,this.u.blocks[this.u.curblock].expr=0;var e=this.newBlock("next branch of if"),f=void 0;void 0!=a.orelse&&a.orelse.length&&(f=this.newBlock("alternative branch of if")),this._jumptrue(d,e),void 0!=f?this._jumpfalse(d,f):this._jump(c,1),this.u.blocks[this.u.curblock].lineno=this.u.lineno-1,this.setBlock(e),this.vseqstmt(a.body),this._jump(c,1),void 0!=f&&(this.setBlock(f),a.orelse&&this.vseqstmt(a.orelse),this._jump(c,1))}this.setBlock(c)},Compiler.prototype.cwhile=function(a){var b=this.exprConstant(a.test);if(0===b)a.orelse&&this.vseqstmt(a.orelse);else{var c=this.u.curblock,d=this.vexpr(a.test);this.u.blocks[this.u.curblock].lineno=this.u.lineno-1,this.u.blocks[this.u.curblock].expr=0;var e=this.newBlock("after while"),f=a.orelse.length>0?this.newBlock("while orelse"):null,g=this.newBlock("while body");this._jumpfalse(d,f?f:e,1),this._jump(g),this.pushBreakBlock(e),this.pushContinueBlock(c),this.u.blocks[this.u.curblock].lineno=this.u.lineno-1,this.setBlock(g),this.vseqstmt(a.body),this._jump(c),this.popContinueBlock(),this.popBreakBlock(),a.orelse.length>0&&(this.setBlock(f),this.vseqstmt(a.orelse)),this.setBlock(e),this.u.blocks[this.u.curblock].lineno=a.lineno-1}},Compiler.prototype.cfor=function(a){this.u.lineno-1;var c=this.newBlock("for start"),d=this.newBlock("for end");this.pushBreakBlock(d),this.pushContinueBlock(c);var e=this.vexpr(a.iter);this.u.blocks[this.u.curblock].expr=1;var f;this.u.ste.generator?(f=this.getCurrentLevel()+".loc."+ +this.gensym("iter"),out(f,"=Sk.abstr.iter(",e,");")):f=this._gr("iter","Sk.abstr.iter(",e,")"),this._jump(c),this.setBlock(c);var g=this._gr("next","Sk.abstr.iternext(",f,")"),h=this.newBlock("for cleanup");this._jumpundef(g,h,1),this.vexpr(a.target,g),this.u.blocks[this.u.curblock].lineno=this.u.lineno-1;var j=this.newBlock("for body");this._jump(j),this.setBlock(j),this.u.blocks[this.u.curblock].expr=0,this.vseqstmt(a.body),this._jump(c),this.setBlock(h),this.popContinueBlock(),this.popBreakBlock(),this.vseqstmt(a.orelse),this._jump(d,!a.orelse||a.orelse&&!a.orelse.length),this.setBlock(d)},Compiler.prototype.craise=function(a){if("StopIteration"===a.type.id.v)out("return undefined;");else{var b="";a.inst&&(b=this.vexpr(a.inst)),out("throw new ",this.vexpr(a.type),"(",b,");")}},Compiler.prototype.ctryexcept=function(a){var b=this.newBlock("except"),c=this.newBlock("orelse"),d=this.newBlock("end");this.setupExcept(b),this.vseqstmt(a.body),this.endExcept(),this._jump(c),this.setBlock(b);for(var e=a.handlers.length,f=0;e>f;++f){var g=a.handlers[f];if(g.type&&e-1>f)throw new SyntaxError("default 'except:' must be last");b=this.newBlock("except_"+f+"_"),g.type&&this._jumpfalse(this.vexpr(g.type),b),this.vseqstmt(g.body)}this.setBlock(c),this.vseqstmt(a.orelse),this._jump(d),this.setBlock(d)},Compiler.prototype.ctryfinally=function(){out("/*todo; tryfinally*/")},Compiler.prototype.cassert=function(a){var b=this.vexpr(a.test),c=this.newBlock("end");this._jumptrue(b,c),out("throw new Sk.builtins.AssertionError(",a.msg?this.vexpr(a.msg):"",");"),this.setBlock(c)},Compiler.prototype.cimportas=function(a,b,c){var d=a.v,e=d.indexOf("."),f=c;if(-1!==e)for(d=d.substr(e+1);-1!==e;){e=d.indexOf(".");var g=-1!==e?d.substr(0,e):d;f=this._gr("lattr","Sk.abstr.gattr(",f,",'",g,"')"),d=d.substr(e+1)}return this.nameop(b,Store,f)},Compiler.prototype.cimport=function(a){for(var b=a.names.length,c=0;b>c;++c){var d=a.names[c],e=this._gr("module","Sk.builtin.__import__(",d.name.$r().v,",$gbl["+Sk.problem+"],$loc["+Sk.problem+"],[])");if(d.asname)this.cimportas(d.name,d.asname,e);else{var f=d.name,g=f.v.indexOf(".");-1!==g&&(f=new Sk.builtin.str(f.v.substr(0,g))),this.nameop(f,Store,e)}}},Compiler.prototype.cfromimport=function(a){for(var b=a.names.length,c=[],d=0;b>d;++d)c[d]=a.names[d].name.$r().v;for(var e=this._gr("module","Sk.builtin.__import__(",a.module.$r().v,",$gbl["+Sk.problem+"],$loc["+Sk.problem+"],[",c,"])"),d=0;b>d;++d){var f=a.names[d];if(0===d&&"*"===f.name.v)return goog.asserts.assert(1===b),out("Sk.importStar(",e,");"),void 0;var g=this._gr("item","Sk.abstr.gattr(",e,",",f.name.$r().v,")"),h=f.name;f.asname&&(h=f.asname),this.nameop(h,Store,g)}},Compiler.prototype.buildcodeobj=function(a,b,c,d,e){var f=[],g=[],h=null,i=null;c&&(f=this.vseqexpr(c)),d&&d.defaults&&(g=this.vseqexpr(d.defaults)),d&&d.vararg&&(h=d.vararg),d&&d.kwarg&&(i=d.kwarg);for(var j,k=0;this.allUnits.length>k;++k)if(this.allUnits[k].scopename==this.u.scopename){j=k;break}var l=this.enterScope(b,a,a.lineno);this.u.parentScope=j;var m=this.u.ste.generator,n=this.u.ste.hasFree,o=this.u.ste.childHasFree,p=this.newBlock("codeobj entry");this.u.prefixCode="var "+l+"=(function "+b.v+"$(";var q=[];if(m)q.push("$gen");else{i&&q.push("$kwa");for(var k=0;d&&d.args.length>k;++k)q.push(this.nameop(d.args[k].id,Param))}this.u.prefixCode+=q.join(","),this.u.prefixCode+="){",m&&(this.u.prefixCode+="\n// generator\n"),n&&(this.u.prefixCode+="\n// has free\n"),o&&(this.u.prefixCode+="\n// has cell\n");var r="{}";m&&(p="$gen.gi$resumeat",r="$gen.gi$locals");var s="";o&&(s=","+this.getCurrentLevel()+".cell={}"),this.u.varDeclsCode+=this.getStack(l)+".push({'loc': {}, 'param': {}, 'blk': "+p+" });";for(var k=0;d&&d.args.length>k;++k)this.u.varDeclsCode+=this.nameop(d.args[k].id,Load,void 0,!0)+" = "+this.nameop(d.args[k].id,Param)+";";this.u.varDeclsCode+=this.getCurrentLevel(l)+".parent = $loc["+Sk.problem+"].parent;\n",this.u.varDeclsCode+=this.getCurrentLevel(l)+".parentName =$loc["+Sk.problem+"].parentName;\n",this.u.varDeclsCode+=this.getCurrentLevel(l)+".parentStack = $loc["+Sk.problem+"].parentStack;\n",this.u.varDeclsCode+=this.getCurrentLevel(l)+".call = $loc["+Sk.problem+"].call;\n",this.u.varDeclsCode+="$loc["+Sk.problem+"].parent = undefined;\n",this.u.varDeclsCode+="$loc["+Sk.problem+"].parentName = undefined;\n",this.u.varDeclsCode+="$loc["+Sk.problem+"].parentStack = undefined;\n",this.u.varDeclsCode+="$loc["+Sk.problem+"].call = undefined;\n",this.u.varDeclsCode+="$scope["+Sk.problem+"] = "+(this.allUnits.length-1)+";",this.u.varDeclsCode+="$scopename["+Sk.problem+'] = "'+l+'";',this.u.varDeclsCode+="$scopestack["+Sk.problem+"] = $loc["+Sk.problem+"]."+l+".stack.length - 1;",this.u.varDeclsCode+=this.getCurrentLevel()+".cell={};\n";for(var k=0;d&&d.args.length>k;++k){var t=d.args[k].id;this.isCell(t)&&(this.u.varDeclsCode+=this.getCurrentLevel(l)+".cell."+t.v+"="+this.nameop(d.args[k].id,Load,void 0,!0)+";\n")}if(g.length>0)for(var u=d.args.length-g.length,k=0;g.length>k;++k){var v=this.nameop(d.args[k+u].id,Param);this.u.varDeclsCode+="if("+this.getCurrentLevel()+".param."+v+"===undefined)"+this.getCurrentLevel()+".param."+v+" = $loc["+Sk.problem+"]."+l+".defaults["+k+"];"}if(h){var w=q.length;this.u.varDeclsCode+=h.v+"=new Sk.builtins['tuple'](Array.prototype.slice.call(arguments,"+w+")); /*vararg*/"}i&&(this.u.varDeclsCode+=i.v+"=new Sk.builtins['dict']($kwa);"),this.u.switchCode+="switch("+this.getCurrentLevel(l)+".blk){",this.u.suffixCode="};",e.call(this,l);var x;if(d&&d.args.length>0){for(var y=[],k=0;d.args.length>k;++k)y.push(d.args[k].id.v);x=y.join("', '"),this.u.argnames=y}this.exitScope(),g.length>0&&out("$loc["+Sk.problem+"]."+l+".defaults=[",g.join(","),"];"),x&&out(l,".co_varnames=['",x,"'];"),i&&out(l,".co_kwargs=1;");var z="";return m?d&&d.args.length>0?this._gr("gener","(function(){var $origargs=Array.prototype.slice.call(arguments);return new Sk.builtins['generator'](",l,",$gbl["+Sk.problem+"],$origargs",z,");})"):this._gr("gener","(function(){return new Sk.builtins['generator'](",l,",$gb["+Sk.problem+"]l,[]",z,");})"):this._gr("funcobj","new Sk.builtins['function'](",l,",$gbl["+Sk.problem+"]",z,")")},Compiler.prototype.cfunction=function(a){goog.asserts.assert(a instanceof FunctionDef),this.u.blocks[this.u.curblock].expr=1,this.u.blocks[this.u.curblock].funcdef=1;var b=this.buildcodeobj(a,a.name,a.decorator_list,a.args,function(){for(var c=0;a.args&&a.args.args.length>c;++c)out(this.nameop(a.args.args[c].id,Load)+" = "+this.nameop(a.args.args[c].id,Load,void 0,!0)+";");this.u.blocks[this.u.curblock].lineno=a.lineno-1,this.vseqstmt(a.body,!0),"Return"!=a.body[a.body.length-1]._astname&&(out("eval("+this.getCurrentLevel()+'.call + " = null;");\n'),out("$scope["+Sk.problem+"] = "+this.getCurrentLevel()+".parent;\n"),out("$scopename["+Sk.problem+"] = "+this.getCurrentLevel()+".parentName;\n"),out("$scopestack["+Sk.problem+"] = "+this.getCurrentLevel()+".parentStack;\n"),out('eval("',this.getStack(),'.pop();");\n')),out("break;\n")});this.nameop(a.name,Store,b,void 0,!0)},Compiler.prototype.clambda=function(a){goog.asserts.assert(a instanceof Lambda);var b=this.buildcodeobj(a,new Sk.builtin.str("<lambda>"),null,a.args,function(){var c=this.vexpr(a.body);out("return ",c,";")});return b},Compiler.prototype.cifexp=function(a){var b=this.newBlock("next of ifexp"),c=this.newBlock("end of ifexp"),d=this._gr("res","null"),e=this.vexpr(a.test);return this._jumpfalse(e,b,1),out(d,"=",this.vexpr(a.body),";"),this._jump(c,1),this.setBlock(b),out(d,"=",this.vexpr(a.orelse),";"),this._jump(c,1),this.setBlock(c),d},Compiler.prototype.cgenexpgen=function(a,b,c){var d=this.newBlock("start for "+b),e=this.newBlock("skip for "+b);this.newBlock("if cleanup for "+b);var i,g=this.newBlock("end for "+b),h=a[b];if(0===b)i=this.getCurrentLevel()+".loc."+"$iter0";else{var j=this.vexpr(h.iter);i=this.getCurrentLevel()+".loc."+this.gensym("iter"),out(i,"=","Sk.abstr.iter(",j,");")}this._jump(d),this.setBlock(d);var k=this._gr("next","Sk.abstr.iternext(",i,")");this._jumpundef(k,g),this.vexpr(h.target,k);for(var m=h.ifs.length,n=0;m>n;++n){var o=this.vexpr(h.ifs[n]);this._jumpfalse(o,d)}if(++b<a.length&&this.cgenexpgen(a,b,c),b>=a.length){var p=this.vexpr(c);out("return [",e,"/*resume*/,",p,"/*ret*/];"),this.setBlock(e)}this._jump(d),this.setBlock(g),1===b&&out("return null;")},Compiler.prototype.cgenexp=function(a){var b=this.buildcodeobj(a,new Sk.builtin.str("<genexpr>"),null,null,function(){this.cgenexpgen(a.generators,0,a.elt)}),c=this._gr("gener",b,"()");return out(c,".gi$locals.$iter0=Sk.abstr.iter(",this.vexpr(a.generators[0].iter),");"),c},Compiler.prototype.cclass=function(a){goog.asserts.assert(a instanceof ClassDef),a.decorator_list;var c=this.vseqexpr(a.bases),d=this.enterScope(a.name,a,a.lineno),e=this.newBlock("class entry");this.u.prefixCode="var "+d+"=(function $"+a.name.v+"$class_outer($globals,$locals,$rest){var $gbl["+Sk.problem+"]=$globals,$loc["+Sk.problem+"]=$locals;",this.u.switchCode+="return(function "+a.name.v+"(){",this.u.switchCode+="var $blk="+e+",$exc=[];while(true){switch($blk){",this.u.suffixCode="}break;}}).apply(null,$rest);});",this.u.private_=a.name,this.cbody(a.body),out("break;"),this.exitScope();var f=this._gr("built","Sk.misceval.buildClass($gbl["+Sk.problem+"],",d,",",a.name.$r().v,",[",c,"])");this.nameop(a.name,Store,f)},Compiler.prototype.ccontinue=function(){if(0===this.u.continueBlocks.length)throw new SyntaxError("'continue' outside loop");this._jump(this.u.continueBlocks[this.u.continueBlocks.length-1])},Compiler.prototype.vstmt=function(a){switch(this.u.lineno=a.lineno,this.u.linenoSet=!1,this.annotateSource(a),a.constructor){case FunctionDef:this.cfunction(a);break;case ClassDef:this.cclass(a);break;case Return_:if(this.u.ste.blockType!==FunctionBlock)throw new SyntaxError("'return' outside function");a.value?out("eval("+this.getCurrentLevel()+'.call + " = ',this.vexpr(a.value),';");\n'):out("eval("+this.getCurrentLevel()+'.call + " = null;");'),out("$scope["+Sk.problem+"] = "+this.getCurrentLevel()+".parent;\n"),out("$scopename["+Sk.problem+"] = "+this.getCurrentLevel()+".parentName;\n"),out("$scopestack["+Sk.problem+"] = "+this.getCurrentLevel()+".parentStack;\n"),out('eval("',this.getStack(),'.pop();");\n'),out("break;\n");break;case Delete_:this.vseqexpr(a.targets);break;case Assign:for(var b=a.targets.length,c=this.vexpr(a.value),d=0;b>d;++d)this.vexpr(a.targets[d],c);this.u.blocks[this.u.curblock].expr=0;break;case AugAssign:return this.caugassign(a);case Print:this.cprint(a);break;case For_:return this.cfor(a);case While_:return this.cwhile(a);case If_:return this.cif(a);case Raise:return this.craise(a);case TryExcept:return this.ctryexcept(a);case TryFinally:return this.ctryfinally(a);case Assert:return this.cassert(a);case Import_:return this.cimport(a);case ImportFrom:return this.cfromimport(a);case Global:break;case Expr:this.vexpr(a.value);break;case Pass:break;case Break_:if(0===this.u.breakBlocks.length)throw new SyntaxError("'break' outside loop");this._jump(this.u.breakBlocks[this.u.breakBlocks.length-1]);break;case Continue_:this.ccontinue(a);break;default:goog.asserts.fail("unhandled case in vstmt")}},Compiler.prototype.vseqstmt=function(a,b){for(var c,d=0;a.length>d;++d)(d||b&&!d)&&(c=this.newBlock(),this._jump(c),this.setBlock(c)),this.vstmt(a[d]),a[d].constructor!=If_&&(this.u.blocks[this.u.curblock].lineno=a[d].lineno-1)};var OP_FAST=0,OP_GLOBAL=1,OP_DEREF=2,OP_NAME=3,D_NAMES=0,D_FREEVARS=1,D_CELLVARS=2;Compiler.prototype.isCell=function(a){var b=mangleName(this.u.private_,a).v,c=this.u.ste.getScope(b);return c===CELL?!0:!1},Compiler.prototype.nameop=function(a,b,c,d,e){if(b!==Store&&b!==AugStore&&b!==Del||"__debug__"!==a.v||this.error("can not assign to __debug__"),b!==Store&&b!==AugStore&&b!==Del||"None"!==a.v||this.error("can not assign to None"),"None"===a.v)return"null";if("True"===a.v)return"true";if("False"===a.v)return"false";var f=mangleName(this.u.private_,a).v,h=OP_NAME,i=this.u.ste.getScope(f),j=null;switch(i){case FREE:j="$free",h=OP_NAME;break;case CELL:j=this.getCurrentLevel()+".cell",h=OP_NAME;break;case LOCAL:this.u.ste.blockType!==FunctionBlock||this.u.ste.generator||e||(h=OP_FAST);break;case GLOBAL_EXPLICIT:h=OP_GLOBAL;default:}f=fixReservedWords(f),goog.asserts.assert(i||"_"===a.v.charAt(1));var k=f;switch(this.u.ste.generator||this.u.ste.blockType!==FunctionBlock?f=this.getCurrentLevel()+".loc."+f:(h===OP_FAST||h===OP_NAME)&&b!=Param&&(f=this.getCurrentLevel()+(d?".param.":".loc.")+f),h){case OP_FAST:switch(b){case Load:case Param:return f;case Store:out(f,"=",c,";");break;case Del:out("delete ",f,";");break;default:goog.asserts.fail("unhandled")}break;case OP_NAME:switch(b){case Load:var l=this.gensym("loadname");return out("var t_scope = $scope["+Sk.problem+"], t_scopename = $scopename["+Sk.problem+"], t_scopestack = $scopestack["+Sk.problem+"];\n"),out("while (",'eval("$loc['+Sk.problem+']." + t_scopename + ".stack[" + t_scopestack + "].loc." + "'+k+'")'," == undefined && \n",'eval("$loc['+Sk.problem+']." + t_scopename + ".stack[" + t_scopestack + "].parentStack != undefined"))\n','{t_scope = eval("$loc['+Sk.problem+']." + t_scopename + ".stack[" + t_scopestack + "].parent");\n',"var nm = t_scopename;",'t_scopename = eval("$loc['+Sk.problem+']." + t_scopename + ".stack[" + t_scopestack + "].parentName");\n','t_scopestack = eval("$loc['+Sk.problem+']." + nm + ".stack[" + t_scopestack + "].parentStack");}'),out(l,"=",'eval("$loc['+Sk.problem+']." + t_scopename + ".stack[" + t_scopestack + "].loc." + "'+k+'")',"!==undefined?",'eval("$loc['+Sk.problem+']." + t_scopename + ".stack[" + t_scopestack + "].loc." + "'+k+'")',":Sk.misceval.loadname('",k,"',$gbl["+Sk.problem+"]);"),e?[l,'"$loc['+Sk.problem+']." + t_scopename + ".stack[" + t_scopestack + "].loc.'+k+'"']:l;case Store:out(f,"=",c,";");break;case Del:out("delete ",f,";");break;case Param:return f;default:goog.asserts.fail("unhandled")}break;case OP_GLOBAL:switch(b){case Load:return this._gr("loadgbl","Sk.misceval.loadname('",k,"',$gbl["+Sk.problem+"])");case Store:out("$gbl["+Sk.problem+"].",k,"=",c,";");break;case Del:out("delete $gbl["+Sk.problem+"].",k);break;default:goog.asserts.fail("unhandled case in name op_global")}break;case OP_DEREF:switch(b){case Load:return j+"."+k;case Store:out(j,".",k,"=",c,";");break;case Param:return k;default:goog.asserts.fail("unhandled case in name op_deref")}break;default:goog.asserts.fail("unhandled case")}},Compiler.prototype.enterScope=function(a,b,c){var d=new CompilerUnit;d.ste=this.st.getStsForAst(b),d.name=a,d.firstlineno=c,this.stack.push(this.u),this.allUnits.push(d);var e="scope"+this.gensymcount++;return d.scopename=e,this.u=d,this.u.activateScope(),this.nestlevel++,e},Compiler.prototype.exitScope=function(){var a=this.u;this.nestlevel--,this.u=this.stack.length-1>=0?this.stack.pop():null,this.u&&this.u.activateScope(),"<module>"!==a.name.v&&out(a.scopename,".co_name=new Sk.builtins['str'](",a.name.$r().v,");")},Compiler.prototype.cbody=function(a){for(var b,c=0;a.length>c;++c)c&&(b=this.newBlock(),this._jump(b),this.setBlock(b)),this.vstmt(a[c]),a[c].constructor!=If_&&(this.u.blocks[this.u.curblock].lineno=a[c].lineno-1)},Compiler.prototype.cprint=function(a){goog.asserts.assert(a instanceof Print);var b="null";a.dest&&(b=this.vexpr(a.dest));for(var c=a.values.length,d=0;c>d;++d)out("Sk.misceval.print_(","new Sk.builtins['str'](",this.vexpr(a.values[d]),").v);");this.u.blocks[this.u.curblock].expr=0,a.nl&&out("Sk.misceval.print_(",'"\\n");')},Compiler.prototype.cmod=function(a){var b=this.enterScope(new Sk.builtin.str("<module>"),a,0);this.newBlock("module entry");var d=this.getCurrentLevel(b);
switch(this.u.prefixCode="",this.u.varDeclsCode=d+".blk = 0; $scope["+Sk.problem+"] = 0; $scopestack["+Sk.problem+"] = 0; $scopename["+Sk.problem+"] = '"+b+"';",this.u.switchCode="switch("+this.getCurrentLevel(b)+".blk){",this.u.suffixCode="}",a.constructor){case Module:this.cbody(a.body),out(this.getCurrentLevel(b)+".blk = -1; break;");break;default:goog.asserts.fail("todo; unhandled case in compilerMod")}this.exitScope();for(var e=0;a.body.length>e&&"FunctionDef"==a.body[e]._astname;++e);return this.allUnits[0].firstlineno=a.body.length>e?this.allUnits[0].blocks[e].lineno:-1,this.result.push(this.outputAllUnits()),b},Sk.compile=function(a,b){var d=Sk.parse(b,a),e=Sk.astFromParse(d,b),f=Sk.symboltable(e,b),g=new Compiler(b,f,0,a),h=g.cmod(e),i=g.result.join("");return{funcname:h,code:i,scopes:g.allUnits,ast:e}},goog.exportSymbol("Sk.compile",Sk.compile);