function Symbol(a,b,c){this.__name=a,this.__flags=b,this.__scope=b>>SCOPE_OFF&SCOPE_MASK,this.__namespaces=c||[]}function SymbolTableScope(a,b,c,d,e){this.symFlags={},this.name=b,this.varnames=[],this.children=[],this.blockType=c,this.isNested=!1,this.hasFree=!1,this.childHasFree=!1,this.generator=!1,this.varargs=!1,this.varkeywords=!1,this.returnsValue=!1,this.lineno=e,this.table=a,a.cur&&(a.cur.nested||a.cur.blockType===FunctionBlock)&&(this.isNested=!0),d.scopeId=astScopeCounter++,a.stss[d.scopeId]=this,this.symbols={}}function SymbolTable(a){this.filename=a,this.cur=null,this.top=null,this.stack=[],this.global=null,this.curClass=null,this.tmpname=0,this.stss={}}function _dictUpdate(a,b){for(var c in b)a[c]=b[c]}var DEF_GLOBAL=1,DEF_LOCAL=2,DEF_PARAM=4,USE=8,DEF_STAR=16,DEF_DOUBLESTAR=32,DEF_INTUPLE=64,DEF_FREE=128,DEF_FREE_GLOBAL=256,DEF_FREE_CLASS=512,DEF_IMPORT=1024,DEF_BOUND=DEF_LOCAL|DEF_PARAM|DEF_IMPORT,SCOPE_OFF=11,SCOPE_MASK=7,LOCAL=1,GLOBAL_EXPLICIT=2,GLOBAL_IMPLICIT=3,FREE=4,CELL=5,OPT_IMPORT_STAR=1,OPT_EXEC=2,OPT_BARE_EXEC=4,OPT_TOPLEVEL=8,GENERATOR=2,GENERATOR_EXPRESSION=2,ModuleBlock="module",FunctionBlock="function",ClassBlock="class";Symbol.prototype.get_name=function(){return this.__name},Symbol.prototype.is_referenced=function(){return!!(this.__flags&USE)},Symbol.prototype.is_parameter=function(){return!!(this.__flags&DEF_PARAM)},Symbol.prototype.is_global=function(){return this.__scope===GLOBAL_IMPLICIT||this.__scope==GLOBAL_EXPLICIT},Symbol.prototype.is_declared_global=function(){return this.__scope==GLOBAL_EXPLICIT},Symbol.prototype.is_local=function(){return!!(this.__flags&DEF_BOUND)},Symbol.prototype.is_free=function(){return this.__scope==FREE},Symbol.prototype.is_imported=function(){return!!(this.__flags&DEF_IMPORT)},Symbol.prototype.is_assigned=function(){return!!(this.__flags&DEF_LOCAL)},Symbol.prototype.is_namespace=function(){return this.__namespaces&&this.__namespaces.length>0},Symbol.prototype.get_namespaces=function(){return this.__namespaces};var astScopeCounter=0;SymbolTableScope.prototype.get_type=function(){return this.blockType},SymbolTableScope.prototype.get_name=function(){return this.name},SymbolTableScope.prototype.get_lineno=function(){return this.lineno},SymbolTableScope.prototype.is_nested=function(){return this.isNested},SymbolTableScope.prototype.has_children=function(){return this.children.length>0},SymbolTableScope.prototype.get_identifiers=function(){return this._identsMatching(function(){return!0})},SymbolTableScope.prototype.lookup=function(a){var b;if(this.symbols.hasOwnProperty(a))b=this.symbols[a];else{var c=this.symFlags[a],d=this.__check_children(a);b=this.symbols[a]=new Symbol(a,c,d)}return b},SymbolTableScope.prototype.__check_children=function(a){for(var b=[],c=0;this.children.length>c;++c){var d=this.children[c];d.name===a&&b.push(d)}return b},SymbolTableScope.prototype._identsMatching=function(a){var b=[];for(var c in this.symFlags)this.symFlags.hasOwnProperty(c)&&a(this.symFlags[c])&&b.push(c);return b.sort(),b},SymbolTableScope.prototype.get_parameters=function(){return goog.asserts.assert("function"==this.get_type(),"get_parameters only valid for function scopes"),this._funcParams||(this._funcParams=this._identsMatching(function(a){return a&DEF_PARAM})),this._funcParams},SymbolTableScope.prototype.get_locals=function(){return goog.asserts.assert("function"==this.get_type(),"get_locals only valid for function scopes"),this._funcLocals||(this._funcLocals=this._identsMatching(function(a){return a&DEF_BOUND})),this._funcLocals},SymbolTableScope.prototype.get_globals=function(){return goog.asserts.assert("function"==this.get_type(),"get_globals only valid for function scopes"),this._funcGlobals||(this._funcGlobals=this._identsMatching(function(a){var b=a>>SCOPE_OFF&SCOPE_MASK;return b==GLOBAL_IMPLICIT||b==GLOBAL_EXPLICIT})),this._funcGlobals},SymbolTableScope.prototype.get_frees=function(){return goog.asserts.assert("function"==this.get_type(),"get_frees only valid for function scopes"),this._funcFrees||(this._funcFrees=this._identsMatching(function(a){var b=a>>SCOPE_OFF&SCOPE_MASK;return b==FREE})),this._funcFrees},SymbolTableScope.prototype.get_methods=function(){if(goog.asserts.assert("class"==this.get_type(),"get_methods only valid for class scopes"),!this._classMethods){for(var a=[],b=0;this.children.length>b;++b)a.push(this.children[b].name);a.sort(),this._classMethods=a}return this._classMethods},SymbolTableScope.prototype.getScope=function(a){var b=this.symFlags[a];return void 0===b?0:b>>SCOPE_OFF&SCOPE_MASK},SymbolTable.prototype.getStsForAst=function(a){goog.asserts.assert(void 0!==a.scopeId,"ast wasn't added to st?");var b=this.stss[a.scopeId];return goog.asserts.assert(void 0!==b,"unknown sym tab entry"),b},SymbolTable.prototype.SEQStmt=function(a){goog.asserts.assert(goog.isArrayLike(a),"SEQ: nodes isn't array? got %s",a);for(var b=a.length,c=0;b>c;++c){var d=a[c];d&&this.visitStmt(d)}},SymbolTable.prototype.SEQExpr=function(a){goog.asserts.assert(goog.isArrayLike(a),"SEQ: nodes isn't array? got %s",a);for(var b=a.length,c=0;b>c;++c){var d=a[c];d&&this.visitExpr(d)}},SymbolTable.prototype.enterBlock=function(a,b,c,d){var e=null;this.cur&&(e=this.cur,this.stack.push(this.cur)),this.cur=new SymbolTableScope(this,a,b,c,d),"top"===a&&(this.global=this.cur.symFlags),e&&e.children.push(this.cur)},SymbolTable.prototype.exitBlock=function(){this.cur=null,this.stack.length>0&&(this.cur=this.stack.pop())},SymbolTable.prototype.visitParams=function(a,b){for(var c=0;a.length>c;++c){var d=a[c];if(d.constructor!==Name)throw new SyntaxError("invalid expression in parameter list");goog.asserts.assert(d.ctx===Param||d.ctx===Store&&!b),this.addDef(d.id,DEF_PARAM)}},SymbolTable.prototype.visitArguments=function(a){a.args&&this.visitParams(a.args,!0),a.vararg&&(this.addDef(a.vararg,DEF_PARAM),this.cur.varargs=!0),a.kwarg&&(this.addDef(a.kwarg,DEF_PARAM),this.cur.varkeywords=!0)},SymbolTable.prototype.newTmpname=function(){this.addDef(new Sk.builtin.str("_["+ ++this.tmpname+"]"),DEF_LOCAL)},SymbolTable.prototype.addDef=function(a,b){var c=mangleName(this.curClass,new Sk.builtin.str(a)).v,d=this.cur.symFlags[c];if(void 0!==d){if(b&DEF_PARAM&&d&DEF_PARAM)throw new Sk.builtin.SyntaxError("duplicate argument '"+a+"' in function definition");d|=b}else d=b;if(this.cur.symFlags[c]=d,b&DEF_PARAM)this.cur.varnames.push(c);else if(b&DEF_GLOBAL){d=b;var e=this.global[c];void 0!==e&&(d|=e),this.global[c]=d}},SymbolTable.prototype.visitSlice=function(a){switch(a.constructor){case Slice:a.lower&&this.visitExpr(a.lower),a.upper&&this.visitExpr(a.upper),a.step&&this.visitExpr(a.step);break;case ExtSlice:for(var b=0;a.dims.length>b;++b)this.visitSlice(a.dims[b]);break;case Index:this.visitExpr(a.value);break;case Ellipsis:}},SymbolTable.prototype.visitStmt=function(a){switch(goog.asserts.assert(void 0!==a,"visitStmt called with undefined"),a.constructor){case FunctionDef:this.addDef(a.name,DEF_LOCAL),a.args.defaults&&this.SEQExpr(a.args.defaults),a.decorator_list&&this.SEQExpr(a.decorator_list),this.enterBlock(a.name.v,FunctionBlock,a,a.lineno),this.visitArguments(a.args),this.SEQStmt(a.body),this.exitBlock();break;case ClassDef:this.addDef(a.name,DEF_LOCAL),this.SEQExpr(a.bases),a.decorator_list&&this.SEQExpr(a.decorator_list),this.enterBlock(a.name.v,ClassBlock,a,a.lineno);var b=this.curClass;this.curClass=a.name,this.SEQStmt(a.body),this.curCalss=b,this.exitBlock();break;case Return_:if(a.value&&(this.visitExpr(a.value),this.cur.returnsValue=!0,this.cur.generator))throw new SyntaxError("'return' with argument inside generator");break;case Delete_:this.SEQExpr(a.targets);break;case Assign:this.SEQExpr(a.targets),this.visitExpr(a.value);break;case AugAssign:this.visitExpr(a.target),this.visitExpr(a.value);break;case Print:a.dest&&this.visitExpr(a.dest),this.SEQExpr(a.values);break;case For_:this.visitExpr(a.target),this.visitExpr(a.iter),this.SEQStmt(a.body),a.orelse&&this.SEQStmt(a.orelse);break;case While_:this.visitExpr(a.test),this.SEQStmt(a.body),a.orelse&&this.SEQStmt(a.orelse);break;case If_:this.visitExpr(a.test),this.SEQStmt(a.body),a.orelse&&this.SEQStmt(a.orelse);break;case Raise:a.type&&(this.visitExpr(a.type),a.inst&&(this.visitExpr(a.inst),a.tback&&this.visitExpr(a.tback)));break;case TryExcept:this.SEQStmt(a.body),this.SEQStmt(a.orelse),this.visitExcepthandlers(a.handlers);break;case TryFinally:this.SEQStmt(a.body),this.SEQStmt(a.finalbody);break;case Assert:this.visitExpr(a.test),a.msg&&this.visitExpr(a.msg);break;case Import_:case ImportFrom:this.visitAlias(a.names);break;case Exec:this.visitExpr(a.body),a.globals&&(this.visitExpr(a.globals),a.locals&&this.visitExpr(a.locals));break;case Global:for(var c=a.names.length,d=0;c>d;++d){var e=mangleName(this.curClass,a.names[d]).v,f=this.cur.symFlags[e];if(f&(DEF_LOCAL|USE))throw f&DEF_LOCAL?new SyntaxError("name '"+e+"' is assigned to before global declaration"):new SyntaxError("name '"+e+"' is used prior to global declaration");this.addDef(new Sk.builtin.str(e),DEF_GLOBAL)}break;case Expr:this.visitExpr(a.value);break;case Pass:case Break_:case Continue_:break;case With_:this.newTmpname(),this.visitExpr(a.context_expr),a.optional_vars&&(this.newTmpname(),this.visitExpr(a.optional_vars)),this.SEQStmt(a.body);break;default:goog.asserts.fail("Unhandled type "+a.constructor.name+" in visitStmt")}},SymbolTable.prototype.visitExpr=function(a){switch(goog.asserts.assert(void 0!==a,"visitExpr called with undefined"),a.constructor){case BoolOp:this.SEQExpr(a.values);break;case BinOp:this.visitExpr(a.left),this.visitExpr(a.right);break;case UnaryOp:this.visitExpr(a.operand);break;case Lambda:this.addDef(new Sk.builtin.str("lambda"),DEF_LOCAL),a.args.defaults&&this.SEQExpr(a.args.defaults),this.enterBlock("lambda",FunctionBlock,a,a.lineno),this.visitArguments(a.args),this.visitExpr(a.body),this.exitBlock();break;case IfExp:this.visitExpr(a.test),this.visitExpr(a.body),this.visitExpr(a.orelse);break;case Dict:this.SEQExpr(a.keys),this.SEQExpr(a.values);break;case ListComp:this.newTmpname(),this.visitExpr(a.elt),this.visitComprehension(a.generators,0);break;case GeneratorExp:this.visitGenexp(a);break;case Yield:if(a.value&&this.visitExpr(a.value),this.cur.generator=!0,this.cur.returnsValue)throw new SyntaxError("'return' with argument inside generator");break;case Compare:this.visitExpr(a.left),this.SEQExpr(a.comparators);break;case Call:this.visitExpr(a.func),this.SEQExpr(a.args);for(var b=0;a.keywords.length>b;++b)this.visitExpr(a.keywords[b].value);a.starargs&&this.visitExpr(a.starargs),a.kwargs&&this.visitExpr(a.kwargs);break;case Num:case Str:break;case Attribute:this.visitExpr(a.value);break;case Subscript:this.visitExpr(a.value),this.visitSlice(a.slice);break;case Name:this.addDef(a.id,a.ctx===Load?USE:DEF_LOCAL);break;case List:case Tuple:this.SEQExpr(a.elts);break;default:goog.asserts.fail("Unhandled type "+a.constructor.name+" in visitExpr")}},SymbolTable.prototype.visitComprehension=function(a,b){for(var c=a.length,d=b;c>d;++d){var e=a[d];this.visitExpr(e.target),this.visitExpr(e.iter),this.SEQExpr(e.ifs)}},SymbolTable.prototype.visitAlias=function(a){for(var b=0;a.length>b;++b){var c=a[b],d=null===c.asname?c.name.v:c.asname.v,e=d,f=d.indexOf(".");if(-1!==f&&(e=d.substr(0,f)),"*"!==d)this.addDef(new Sk.builtin.str(e),DEF_IMPORT);else if(this.cur.blockType!==ModuleBlock)throw new SyntaxError("import * only allowed at module level")}},SymbolTable.prototype.visitGenexp=function(a){var b=a.generators[0];this.visitExpr(b.iter),this.enterBlock("genexpr",FunctionBlock,a,a.lineno),this.cur.generator=!0,this.addDef(new Sk.builtin.str(".0"),DEF_PARAM),this.visitExpr(b.target),this.SEQExpr(b.ifs),this.visitComprehension(a.generators,1),this.visitExpr(a.elt),this.exitBlock()},SymbolTable.prototype.visitExcepthandlers=function(a){for(var c,b=0;c=a[b];++b)c.type&&this.visitExpr(c.type),c.name&&this.visitExpr(c.name),this.SEQStmt(c.body)},SymbolTable.prototype.analyzeBlock=function(a,b,c,d){var e={},f={},g={},h={},i={};a.blockType==ClassBlock&&(_dictUpdate(g,d),b&&_dictUpdate(h,b));for(var j in a.symFlags){var k=a.symFlags[j];this.analyzeName(a,f,j,k,b,e,c,d)}a.blockType!==ClassBlock&&(a.blockType===FunctionBlock&&_dictUpdate(h,e),b&&_dictUpdate(h,b),_dictUpdate(g,d));for(var l={},m=a.children.length,n=0;m>n;++n){var o=a.children[n];this.analyzeChildBlock(o,h,i,g,l),(o.hasFree||o.childHasFree)&&(a.childHasFree=!0)}_dictUpdate(i,l),a.blockType===FunctionBlock&&this.analyzeCells(f,i),this.updateSymbols(a.symFlags,f,b,i,a.blockType===ClassBlock),_dictUpdate(c,i)},SymbolTable.prototype.analyzeChildBlock=function(a,b,c,d,e){var f={};_dictUpdate(f,b);var g={};_dictUpdate(g,c);var h={};_dictUpdate(h,d),this.analyzeBlock(a,f,g,h),_dictUpdate(e,g)},SymbolTable.prototype.analyzeCells=function(a,b){for(var c in a){var d=a[c];d===LOCAL&&void 0!==b[c]&&(a[c]=CELL,delete b[c])}},SymbolTable.prototype.updateSymbols=function(a,b,c,d,e){for(var f in a){var g=a[f],h=b[f];g|=h<<SCOPE_OFF,a[f]=g}var i=FREE<<SCOPE_OFF;for(var f in d){var k=a[f];if(void 0===k)void 0!==c[f]&&(a[f]=i);else if(e&&k&(DEF_BOUND|DEF_GLOBAL)){var l=k|DEF_FREE_CLASS;a[f]=l}}},SymbolTable.prototype.analyzeName=function(a,b,c,d,e,f,g,h){if(d&DEF_GLOBAL){if(d&DEF_PARAM)throw new Sk.builtin.SyntaxError("name '"+c+"' is local and global");return b[c]=GLOBAL_EXPLICIT,h[c]=null,e&&void 0!==e[c]&&delete e[c],void 0}return d&DEF_BOUND?(b[c]=LOCAL,f[c]=null,delete h[c],void 0):(e&&void 0!==e[c]?(b[c]=FREE,a.hasFree=!0,g[c]=null):h&&void 0!==h[c]?b[c]=GLOBAL_IMPLICIT:(a.isNested&&(a.hasFree=!0),b[c]=GLOBAL_IMPLICIT),void 0)},SymbolTable.prototype.analyze=function(){var a={},b={};this.analyzeBlock(this.top,null,a,b)},Sk.symboltable=function(a,b){var c=new SymbolTable(b);c.enterBlock("top",ModuleBlock,a,0),c.top=c.cur;for(var d=0;a.body.length>d;++d)c.visitStmt(a.body[d]);return c.exitBlock(),c.analyze(),c},Sk.dumpSymtab=function(a){var b=function(a){return a?"True":"False"},c=function(a){for(var b=[],c=0;a.length>c;++c)b.push(new Sk.builtin.str(a[c]).$r().v);return"["+b.join(", ")+"]"},d=function(a,e){void 0===e&&(e="");var f="";f+=e+"Sym_type: "+a.get_type()+"\n",f+=e+"Sym_name: "+a.get_name()+"\n",f+=e+"Sym_lineno: "+a.get_lineno()+"\n",f+=e+"Sym_nested: "+b(a.is_nested())+"\n",f+=e+"Sym_haschildren: "+b(a.has_children())+"\n","class"===a.get_type()?f+=e+"Class_methods: "+c(a.get_methods())+"\n":"function"===a.get_type()&&(f+=e+"Func_params: "+c(a.get_parameters())+"\n",f+=e+"Func_locals: "+c(a.get_locals())+"\n",f+=e+"Func_globals: "+c(a.get_globals())+"\n",f+=e+"Func_frees: "+c(a.get_frees())+"\n"),f+=e+"-- Identifiers --\n";for(var g=a.get_identifiers(),h=g.length,i=0;h>i;++i){var j=a.lookup(g[i]);f+=e+"name: "+j.get_name()+"\n",f+=e+"  is_referenced: "+b(j.is_referenced())+"\n",f+=e+"  is_imported: "+b(j.is_imported())+"\n",f+=e+"  is_parameter: "+b(j.is_parameter())+"\n",f+=e+"  is_global: "+b(j.is_global())+"\n",f+=e+"  is_declared_global: "+b(j.is_declared_global())+"\n",f+=e+"  is_local: "+b(j.is_local())+"\n",f+=e+"  is_free: "+b(j.is_free())+"\n",f+=e+"  is_assigned: "+b(j.is_assigned())+"\n",f+=e+"  is_namespace: "+b(j.is_namespace())+"\n";var k=j.get_namespaces(),l=k.length;f+=e+"  namespaces: [\n";for(var m=[],n=0;l>n;++n){var o=k[n];m.push(d(o,e+"    "))}f+=m.join("\n"),f+=e+"  ]\n"}return f};return d(a.top,"")},goog.exportSymbol("Sk.symboltable",Sk.symboltable),goog.exportSymbol("Sk.dumpSymtab",Sk.dumpSymtab);